\subsection{Definició i llei de grup}

\begin{definition}
 Una \emph{corba el·líptica} sobre un cos $K$ és una equació de la forma
 \[
 E\colon y^2 + a_1 xy + a_3 y = x^3 + a_2 x^2 + a_4 x + a_6,
 \]
 on $a_1, a_2, a_3, a_4, a_6\in K$ són tals que
 \[
 \Delta_E = -b_2^2b_8-8b_4^3-27b_6^2+9b_2b_4b_6 \neq 0,
 \]
 amb
 \begin{align*}
 b_2&=a_1^2+4a_2,\\
 b_4&=2a_4+a_1a_3,\\
 b_6&=a_3^2+4a_6, \text{ i}\\
 b_8&=a_1^2a_6+4a_2a_6-a_1a_3a_4+a_2a_3^2-a_4^2.
 \end{align*}
\end{definition}
\begin{remark}
 Si la característica de $K$ és diferent de $2$, aleshores es pot fer un canvi afí de variables que permet escriure $E$ de forma
 \[
 E\colon y^2 = x^3 + ax +b, \quad a,b\in K.
 \]
 En aquest cas, el discriminant $\Delta_E$ té una expressió més senzilla:
\[
\Delta_E = -16(4a^3+27b^2).
\]
\end{remark}

Podem pensar una corba el·líptica $E$ com un cert subconjunt de $\mathbb{P}^2$. En aquest cas cal considerar l'equació homogènia ($x = X/Z$, $y=Y/Z$)
\[
E\colon Y^2Z + a_1 XYZ + a_3 YZ^2 = X^3 + a_2 X^2Z + a_4 XZ^2 + a_6 Z^3.
\]
Quan $Z=0$, obtenim com a solució el punt projectiu $\calO=(0:1:0)$, que anomenarem \emph{punt a l'infinit} d'$E$.

Donat un cos $L\supseteq K$, el conjunt de \emph{punts definits a $L$} és
\[
E(L) = \{(x,y)\in L\times L ~|~ y^2 + a_1xy + a_3 y = x^3 + a_2x^2 + a_4 x + a_6\}\cup \{\calO\}.
\]

La importància de les corbes el·líptiques en la teoria de nombres prové del fet que el conjunt de punts $E(L)$ ve dotat d'una estructura de grup abelià. Ens serà útil el següent lema geomètric:

\begin{lemma}
Tota recta interseca $E$ en tres punts, si els comptem amb multiplicitat.

A més, si dos d'aquests punts tenen coordenades a una extensió $L$, també les hi té el tercer punt.
\end{lemma}

\begin{proof}
Considerem una recta genèrica a $\P^2$, donada per l'equació
\[
\alpha X+\beta Y+\gamma Z=0, \quad \alpha,\beta,\gamma\in L.
\]
Si $\alpha=\beta=0$, aleshores es tracta de la recta a l'infinit, que ja sabem que interseca de manera triple amb $\calO$.

Suposem doncs que $\alpha\neq 0$ o $\beta\neq 0$, i per tant podem treballar amb la forma no-homogènia
\[
\alpha x + \beta y + \gamma = 0.
\]
Si $\alpha \neq 0$, aleshores substituint $x = \frac{-1}{\alpha} (\gamma + \beta y)$ a l'equació d'$E$ obtenim un polinomi en $y$ de grau $3$, i per tant $3$ solucions. També, si $\beta\neq 0$, substituint $y=\frac{-1}{\beta}(\gamma + \alpha x)$ s'obté un polinomi en $x$ de grau $3$ i, per tant les tres solucions.

Suposem que dos dels punts d'intersecció tenen coordenades a $L$. Notem que, per veure que un punt té coordenades a $L$ només cal veure que o bé la seva coordenada $x$ o bé la $y$ és de $L$, ja que l'altra coordenada també ho serà fent servir l'equació de la recta. En els polinomis anteriors, que estan definits a $K$ (en $x$ o en $y$) el producte de les tres arrels és el terme constant i, per tant, és de $K\subseteq L$. Si dues de les arrels són d'$L$, aleshores la tercera també ho és.

\end{proof}


\begin{figure}[ht]
\includegraphics[page=3,width=.5\textwidth]{addingpoints.pdf}
\includegraphics[page=3,width=.5\textwidth]{doublingpoints.pdf}
\caption{Suma de dos punts a $E$}
\end{figure}

Donats dos punts $P,Q \in E(K)$, considerem la recta que $\ell_{P,Q}$ que passa per $P$ i $Q$ (en cas que $P=Q$, aleshores $\ell_{P,P}$ serà la recta tangent a $E$ que passa per $P$).

La recta $\ell_{P,Q}$ interseca en un altre punt $R\in E(K)$. Finalment, definim $P+Q$ com el tercer punt d'intersecció de la recta $\ell_{R,\calO}$.

Òbviament aquesta operació és commutativa, i és fàcil veure que el punt de l'infinit $\calO$ és l'element neutre.

Definim $-P$ com el tercer punt d'intersecció de la recta $\ell_{\calO, P}$. Per definició, $\ell_{P,-P} = \ell_{\calO, P}$, i per tant el punt $R$ és justament $\calO$. Ara, si prenem la recta tangent a $E$ que passa per $\calO$, obtenim la recta de l'infinit $\{ z=0\}$, que talla $E$ només a $\calO$ (intersecció triple). Per tant, concloem que $P+(-P)=\calO$.

L'associativitat d'aquesta operació es pot veure de diferents maneres, però fer-ho ens duria massa lluny. Més endavant en donarem alguna indicació. Així, el conjunt de punts $K$-definits d'$E$ adquireix una estructura addicional: és un grup abelià.

\subsubsection{La llei de grup en coordenades}
Donats punts $P_1=(x_1,y_1)$ i $P_2=(x_2,y_2)$ d'$E$, volem calcular $P_3=(x_3,y_3)=P_1+P_2$. Fixem-nos que, si $P_1=\calO$ o $P_2=\calO$ aleshores el resultat és clar. També si $P_2=-P_1$. Per tant, suposarem que aquest no és el cas. Per simplificar les fórmules, treballarem amb el model
\[
y^2=x^3+a_2x^2+a_4x + a_6.
\]
En aquest cas, fixem-nos que si $P=(x,y)$ aleshores $-P=(x,-y)$.

La recta $\ell_{P_1,P_2}$ té equació
\[
y = \lambda (x-x_1) + y_1, 
\]
on
\[
\lambda=\begin{cases}
\frac{y_2-y_1}{x_2-x_1}&\text{si } P_1\neq P_2,\\
\frac{3x^2+2a_2x + a_4}{2y}&\text{si } P_1=P_2.
\end{cases}
\]
Substituint-ho a l'equació d'$E$, obtenim un polinomi de grau $3$ en $x$, del qual ens fixarem en el terme de grau $2$, que és $a_2-\lambda^2$. Aquest terme es correspon a $-(x_1+x_2+x_3)$ i, per tant, podem aïllar
\[
x_3 = \lambda^2-a_2-x_1-x_2.
\]
La coordenada $y$ de $P_3$ és l'oposat del punt d'intersecció que acabem de calcular. Per tant, obtenim:
\[
y_3 = \lambda (x_1-x_3)-y_1.
\]

Aquestes formules ens permeten verificar l'associativitat de la suma ajudant-nos de \texttt{Sage}. El següent codi ens demostra la següent proposició.

\begin{proposition}
\begin{enumerate}
    \item Si $P,Q,R$ satisfan que els elements
    \[
    \{P,-P,Q,-Q,R,-R,P+Q,-(P+Q),(Q+R),-(Q+R),\calO\}
    \]
    són tots ells diferents, aleshores
    $P+(Q+R)=(P+Q)+R$.
    \item Si $P,Q$ satisfà que els elements
    \[
    \{ P, -P, 2P, -2P, Q, \calO\}
    \]
    són tots ells diferents, aleshores
    \[
    2P+Q = P+(P+Q).
    \]
    \item Si $P\in E(K)$, aleshores
    \[
    2(2P) = P + 3P.
    \]
\end{enumerate}
\end{proposition}
\begin{proof}
 El següent codi en \texttt{Sage} verifica les equacions algebraiques que es corresponen a cada igualtat.

\begin{python}
S.<a2,a4,a6,x1,x2,x3,y1,y2,y3> = PolynomialRing(QQ,8)
I = S.ideal([y1^2-(x1^3 + a2*x1^2 + a4*x1 + a6), \ 
             y2^2-(x2^3 + a2*x2^2 + a4*x2 + a6), \ 
             y3^2-(x3^3 + a2*x3^2 + a4*x3 + a6)])
P = (x1,y1)
Q = (x2,y2)
R = (x3,y3)

def add(P,Q):
    s1 = (Q[1]-P[1]) / (Q[0]-P[0])
    xPQ = s1^2 - a2 - P[0] - Q[0]
    yPQ = -P[1] + s1*(P[0] - xPQ)
    return (xPQ, yPQ)

def double(P):
    s1 = (3*P[0]**2 + 2*a2 *P[0] + a4) / (2 * P[1])
    xPQ = s1^2 - 2*P[0]
    yPQ = -P[1] + s1*(P[0] - xPQ)
    return (xPQ, yPQ)

A = add( add(P, Q), R )
B = add(P, add(Q, R) )
print (A[0] - B[0]).numerator() in I and (A[1] - B[1]).numerator() in I

A = add(double(P),Q)
B = add(P,add(P,Q))
print (A[0] - B[0]).numerator() in I and (A[1] - B[1]).numerator() in I

A = double(add(P,Q))
B = add(P,add(Q,add(P,Q)))
print (A[0] - B[0]).numerator() in I and (A[1] - B[1]).numerator() in I
\end{python}
\end{proof}

\begin{lemma}
Per a qualssevol punts $P$, $Q$ i $R$ d'$E$, es satisfà:
 \begin{enumerate}
     \item $(P+Q)-Q = P$.
     \item $P+R = Q+R \iff P = Q$.
     \item $2P + Q = P+(P+Q)$.
 \end{enumerate}
\end{lemma}
\begin{proof}
 La primera afirmació es comprova amb la definició de suma, fent servir que la recta simètrica a $\ell_{P,Q}$ és la recta $\ell_{P+Q,-Q}$.
 
 La segona afirmació segueix de la primera: si $P+R=Q+R$, aleshores $P = (P+R)-R = (Q+R) -R = Q$.
 
 Finalment, per comprovar l'última afirmació primer cal veure-la quan $Q$ és $\calO$ o $\pm P$, i en aquests casos és fàcil comprovar-ho pel què hem vist fins ara. Si $2P=\calO$ també és fàcil, així com quan $Q=-2P$. El cas $Q=2P$ i el cas general són precisament els que s'han comprovat amb \texttt{Sage}.
\end{proof}
\begin{corollary}
Per a qualssevol punts $P$ i $Q$ d'$E$, es satisfà:
 \begin{enumerate}
     \item $((P+Q)+P)+Q = 2(P+Q)$.
     \item $P+(Q-(P+Q))=\calO$.
 \end{enumerate}
\end{corollary}

Amb aquests resultats, podem demostrar ja l'associativitat de la suma.
\begin{theorem}
La llei de grup definida anteriorment és associativa. Per tant, defineix un grup abelià.
\end{theorem}
\begin{proof}
 Els casos on $\calO\in\{P,Q,R\}$ són obvis. Els casos especials queden coberts amb el lema i corol·lari anteriors, i el cas general s'ha comprovat amb \texttt{Sage}.
\end{proof}
 \subsection{Punts de torsió, punts racionals}
 Donada una corba el·líptica $E$ definida sobre un cos $K$, definim el subgrup de torsió com
 \[
 E(K)_\tors = \{P\in E(K) ~|~ nP=\calO,\text{ per algun } n\geq 1\}.
 \]
 També definim, per cada $n\geq 1$, el subgrup
 \[
 E[n](K) = \{P\in E(K) ~|~ nP=\calO\},
 \]
 de manera que
 \[
 E(K)_\tors = \bigcup_{n\geq 1} E[n](K).
 \]
 Més endavant també ens convindrà escriure $E[n] = E[n](\bar K)$.
 
 El següent resultat, que no demostrarem aquí, ens dona una manera de trobar tots els punts de torsió d'una corba el·líptica definida sobre $\Q$.
 \begin{theorem}[Nagell--Lutz (1935, 1937)]
 Sigui $E$ una corba el·líptica amb equació
 \[
 y^2=x^3+ax+b,\quad a,b\in\Z.
 \]
 Si $P=(x,y)$ pertany a $E(\Q)_\tors$, aleshores:
 \begin{enumerate}
     \item $x,y\in\Z$, i
     \item $y=0$ o $y^2 \mid \Delta_E$.
 \end{enumerate}
 \end{theorem}
\begin{remark}
La condició $a,b \in\Z$ sempre es pot aconseguir satisfer, fent un canvi de variables de la forma $(x',y') = (u^2 x, u^3 y)$ amb un $u\in\Q$ adequat.
\end{remark}

Bastants anys més tard, Barry Mazur va demostrar un teorema molt més difícil, que ens diu l'estructura d'$E(\Q)_\tors$ de manera precisa.
\begin{theorem}[Mazur, 1978]
Sigui $E$ una corba el·líptica definida a $\Q$. Aleshores
\[
E(\Q)_\tors\cong\begin{cases}
\Z/N\Z & 1 \leq N \leq 10,\text{ o } N=12,\\
\Z/2\Z\oplus \Z/2N\Z & 1\leq N \leq 4.
\end{cases}
\]
A més, tots els $15$ possibles subgrups de torsió es donen.
\end{theorem}

El següent teorema fou demostrat per Louis Mordell el 1922, i dedicarem unes quantes pàgines a la seva demostració.

\begin{theorem}[Mordell, 1922]
El grup $E(\Q)$ està generat per un nombre finit de punts.
\end{theorem}

Gràcies al teorema de classificació dels grups abelians finitament generats, en deduïm que
\[
E(\Q) = E(\Q)_\tors \oplus \Z^r,\quad r\geq 0.
\]
L'enter $r$ s'anomena el \emph{rang de Mordell--Weil} d'$E(\Q)$, i avui en dia no hi ha cap algoritme\footnote{Per algoritme volem dir un programa d'ordinador el qual podem garantir que acabi en temps finit.} per calcular-lo, encara que hi ha mètodes que funcionen bastant bé.

\subsubsection{Altures}
Volem definir l'``altura'' d'un racional, de manera que hi hagi finits racionals d'altura fixada.
\begin{definition}
L'\emph{altura} d'un racional $\frac{a}{b}\in\Q$ és
\[
h(a/b) = \log \max\{|a|,|b|\},\quad\text{ si } \gcd(a,b)=1.
\]
Si $P=(x,y)\in E(\Q)$, l'\emph{altura} de $P$ és $h(P)=h(x)$, l'altura de la seva coordenada-$x$. També escriurem $h(\calO)=0$.
\end{definition}

\begin{remark}
Per cada $M>0$, $\{ P\in E(\Q) ~|~ h(P) \leq M\}$ és un conjunt finit.
\end{remark}

\begin{lemma}
Sigui $Q_0\in E(\Q)$. Hi ha una constant $C(Q_0)$ tal que
\[
h(P+Q_0)\leq 2h(P) + C(Q_0), \quad \forall P\in E(\Q).
\]
\end{lemma}
\begin{lemma}
Hi ha una constant $C$ tal que
\[
h(2P)\geq 4h(P) - C,\quad \forall P\in E(\Q).
\]
\end{lemma}

\begin{theorem}
Si $E(\Q)/2E(\Q)$ és finit, aleshores $E(\Q)$ és finitament generat.
\end{theorem}
\begin{proof}
Siguin $Q_1,\ldots, Q_t$ representants del quocient $E(\Q)/2E(\Q)$.
Per tant, donat $P=P_0\in E(\Q)$, podem escriure $P_0 = Q_{i_0} + 2P_1$, amb $P_1\in E(\Q)$. Repetint l'argument amb $P_1$, podem escriure $P_1 = Q_{i_1} + 2P_2$. Per tant,
\[
P = Q_{i_0} + 2P_1 = Q_{i_0} + 2Q_{i_1} + 4P_2.
\]
Després de $n$ iteracions d'aquest argument, obtenim
\[
P = Q_{i_0} + 2Q_{i_1} + 4Q_{i_2}+\cdots +2^{n-1} Q_{i_{n-1}} + 2^{n}P_n
\]
Calculem ara l'altura de $P_j$, per cada $j$. Si escrivim $\bar C = \max\{ C(Q_1),\ldots C(Q_t)\}$, tenim
\[
h(P - Q_i) \leq 2h(P) + C(Q_i)\leq 2h(P) + \bar C.
\]
Aleshores,
\[
4h(P_j)\leq h(2P_j) + C = h(P_{j-1} - Q_{i_{j-1}}) + C\leq 2h(P_{j-1}) + \bar C + C.
\]
Per tant, escrivint $M=\bar C + C$, tenim
\[
h(P_j)\leq \frac{1}{2} h(P_{j-1}) + \frac{M}{4} = \frac{3}{4} h(P_{j-1}) - \frac 14\left(h(P_{j-1}) - M\right).
\]
D'aquí en traiem:
\[
\text{Si } h(P_{j-1})\geq M,\text{ aleshores } h(P_j)\leq \frac 34 h(P_{j-1}).
\]
Per tant, si observem la successió de punts $P_0, P_1, P_2, \ldots$, si tenen altura més gran que $M$, aleshores la seva altura cada vegada es fa més petita (tendint a zero). Aleshores hi ha algun índex $n$ tal que $P_n\in E(\Q)_{\leq M} = \{ P\in E(\Q) ~|~ h(P) \leq M\}$.

Concloem que tot punt $P\in E(\Q)$ es pot escriure com a combinació lineal entera dels punts $Q_1,\ldots Q_t$ i dels finits punts de $E(\Q)_{\leq M}$.
\end{proof}

 \subsubsection{La versió dèbil del teorema de Mordell}
 Ens hem reduït a demostrar el següent resultat.
 \begin{theorem}[Mordell--Weil dèbil]
 El quocient $E(\Q)/2E(\Q)$ és finit.
 \end{theorem}
 \begin{remark}
 De fet, el teorema de Mordell--Weil afirma que, donat un cos de nombres $K$ i un enter $m\geq 2$, el quocient $E(K)/mE(K)$ és finit. Encara que la idea de la demostració és la mateixa, alguns dels ingredients que apareixen en aquest cas més general fan servir eines més avançades que preferim no introduir.
 \end{remark}
 
 Primer ens cal estudiar el grup de $2$-torsió $E[2]$. Fixem-nos que $2P=\calO$ si i només si $P=\calO$ o $P=(x,0)$. Per tant, els punts no trivials de $2$-torsió es corresponen amb les arrels de $x^3+ax+b$. Així, $E[2]$ té ordre $4$. Com que és un grup d'exponent $2$, en deduïm que
 \[
 E[2] \cong \Z/2\Z \oplus \Z/2\Z.
 \]
\begin{remark}
 En general, $E[m]\cong \Z/m\Z\oplus \Z/m\Z$ per a tot $m$, però no ho veurem aquí.
\end{remark}

Suposarem, d'ara en endavant, que $E[m]\subset E(K)$.

Per cada punt $P\in E(K)$, escollim $Q\in E(\bar K)$ tal que $mQ=P$, i definim $L_P=K(x,y)$ com la mínima extensió de $K$ que conté les coordenades $x$ i $y$ de $Q$. Definim també $L$ com la clausura normal de la composició de totes les extensions $L_P$.

Considerem l'aplicació
\[
\phi_P\colon \Gal(L/K)\to E[m],\quad \phi_P(\sigma) = \sigma(Q)-Q.
\]
Observem que
\[
m(\sigma(Q)-Q) = m\sigma(Q)-mQ= \sigma(mQ)- mQ = \sigma(P)-P = \calO,
\]
i per tant $\phi_P(\sigma)\in E[m]$.

Ens agradaria veure que l'aplicació $\phi_P$ no depèn del punt $Q$ triat. Per això, ens caldrà suposar que:

\textbf{Hipòtesi: } $E[m]\subseteq E(K)$.

Si $R$ és una altre punt tal que $mR=P$, aleshores es té $m(Q-R)=P-P=\calO$ i, per tant, $Q-R\in E[m]$. Com que $E[m]\subseteq E(K)$, aleshores
\[
(\sigma(Q)-Q) - (\sigma(R)-R) = \sigma(Q-R)-(Q-R) = (Q-R)-(Q-R)=\calO.
\]
Per tant, $\phi_P$ només depèn de $P$, i no pas del punt $Q\in E(L)$ tal que $mQ=P$.

\begin{remark}
Recordem que hem suposat que $E(K)$ conté $E[m]$. En general, $E[m]$ és finit (només ho hem vist per $m=2$) i per tant aquesta hipòtesi es pot satisfer canviant $K$ per una extensió $K'$ més gran, i que podem suposar de Galois. És fàcil veure que si el teorema de Mordell--Weil dèbil és cert per $E(K')$ amb $K'\supseteq K$ aleshores també és cert per $E(K)$: el nucli de l'aplicació
\[
E(K)/mE(K)\to E(K')/mE(K')
\]
és el conjunt
\[
(E(K)\cap mE(K'))/mE(K)\injects \Hom(\Gal(K'/K), E[m]),\quad P\mapsto\phi_P,
\]
i el grup de la dreta és finit perquè tant $\Gal(K'/K)$ com $E[m]$ ho són.
\end{remark}


\begin{proposition}
Sigui $K$ un cos de nombres, i suposem que $E[m] \subset E(K)$. Aleshores l'assignació $P\mapsto \phi_P$ indueix una injecció
\[
\phi\colon E(K)/mE(K)\injects \Hom(\Gal(L/K), E[m]).
\]
\end{proposition}
\begin{proof}
Ens cal veure:
\begin{enumerate}
    \item Per cada $P\in E(K)$, l'aplicació $\phi_P$ és un morfisme de grups.
    \item $\ker \phi=mE(K)$.
\end{enumerate}
Calculem $\phi_P(\sigma_1\sigma_2)-\phi_P(\sigma_1)-\phi_P(\sigma_2)$, on $\sigma_1,\sigma_2\in\Gal(L/K)$:
\begin{align*}
\phi_P(\sigma_1\sigma_2)-\phi_P(\sigma_1)-\phi_P(\sigma_2)&=(\sigma_1\sigma_2)(Q)-Q - \sigma_1(Q)+Q-\sigma_2(Q)+Q\\
&=\sigma_1(\sigma_2(Q)-Q) - (\sigma_2(Q)-Q).
\end{align*}
Com que $m(\sigma_2(Q)-Q) = \sigma_2(P)-P = \calO$,
tenim que $\sigma_2(Q)-Q\in E[m]\subseteq E(K)$ i, per tant és invariant per $\sigma_1$.

Calculem ara $\ker\phi$. Òbviament, si $P\in mE(K)$, podem triar $Q\in E(K)$ tal que $mQ=P$, i aleshores $\sigma(Q)-Q=\calO$ per a tot $\sigma\in \Gal(L/K)$. Per tant, $mE(K)\subseteq \ker\phi$.

Per acabar, doncs, cal veure que $\ker\phi\subseteq mE(K)$. Per tant, suposem que $P\in E(K)$ és tal que $\sigma(Q)-Q=\calO$ per a tot $\sigma\in \Gal(L/K)$. Això vol dir que $Q\in E(K)$, i per tant $P=mQ\in mE(K)$.
\end{proof}

La proposició que hem demostrat permet veure el quocient que ens interessa com un subgrup d'el grup $\Hom(\Gal(L/K),E[m])$. Si podem demostrar que $L/K$ és una extensió finita, aleshores $\Gal(L/K)$ serà un grup finit. Si a més $E[m]$ és finit (per exemple, en el cas $m=2$ ja ho sabem) aleshores el grup d'homomorfismes entre aquests dos grups finits serà necessàriament finit i haurem demostrat el teorema.

\begin{lemma}
Si $P\not\in E(K)[2]$, aleshores $L_P=K(x(Q))$.
\end{lemma}
\begin{proof}
Prenem $\sigma\in \Gal(\bar K/K(x))$ i volem veure que $\sigma(y)=y$. Com que $\sigma(x)=x$, per l'equació d'$E$ es té $\sigma(y)^2=y^2$, és a dir $\sigma(y)=\pm y$. Suposem, per arribar a contradicció, que $\sigma(y)=-y$. Aleshores $\sigma(Q)=-Q$. Per tant:
\[
P = \sigma(P) = \sigma(2Q)= 2\sigma(Q)=2(-Q) = -P,
\]
i això només pot passar si $P$ és de $2$-torsió.
\end{proof}

%\begin{lemma}
%Hi ha una bijecció natural
%\[
%\Hom(G_K,E[2]) \cong \{ \text{extensions } L/K\text{ %Galois, amb } \Gal(L/K)\subseteq \Z/2\Z\oplus\Z/2\Z\}.
%\]
%\end{lemma}
%\begin{proof}
%Donat $\varphi\colon G_K\to E[2]$, considerem
%$H=\ker\varphi\trianglelefteq G_K$. Com que $G_K/H\subseteq E[2]\cong \Z/2\Z\oplus \Z/2\Z$, el subgrup $H$ és té índex finit a $G_K$. Sigui $L=\bar K^H$ l'extensió Galois finita de $K$ associada a $H$, que té grup de Galois $\Gal(L/K)\subseteq \Z/2\Z\oplus \Z/2\Z$.
%
%Recíprocament, donada una extensió $L/K$ de Galois amb $\Gal(L/K)\subseteq E[2]$, podem definir un morfisme
%\[
%\varphi\colon G_K\surjects \Gal(L/K)\subseteq E[2].
%\]
%És senzill veure que aquestes dues aplicacions són %inverses l'una de l'altra.
%\end{proof}

A partir d'ara ens centrarem en el cas $K=\Q$ i $m=2$, ja que la demostració en el cas més general és notablement més complicada.

\subsubsection{Demostració de la finitud de $L/\Q$}
 Com que $E[2]\subseteq E(\Q)$, fent un canvi de variables podem assumir que $E$ té equació de la forma
 \[
 y^2 = x (x-e_1)(x-e_2),\quad e_1,e_2\in\Q.
 \]
 La fórmula per la duplicació es simplifica, en aquest cas, a
 \[
 x(2Q) = \frac{x^4-2e_1e_2x + e_1^2e_2^2}{4y^2}.
 \]
 
 Sense pèrdua de generalitat, podem restringir-nos a punts $P\in E(\Q)\setminus E[2]$, ja que només obviem un nombre finit de punts. Si $P=(\alpha,\beta)\in E(\Q)$, els punts $Q$ tals que $2Q=P$ hauran de satisfer que $x(2Q)=\alpha$. Com que $y^2=x(x-e_1)(x-e_2)$, això equival a que $x(2Q)$ satisfaci l'equació
 \[
 g(x) = x^4 - 4\alpha x^3 + (4\alpha(e_1+e_2)-2e_1e_2)x^2-4e_1e_2\alpha x + e_1^2e_2^2= 0.
 \]
 El següent codi de \texttt{Sage} ens permet trobar les seves arrels:
 \begin{python}
 var('alpha,e_1,e_2')
 T.<x> = PolynomialRing(SR)
 F = x*(x-e_1)*(x-e_2)
 g = (4*F*(e_1 + e_2 - 2*x) + 
     (3*x^2-2*(e_1+e_2)*x+e_1*e_2)**2) -
     alpha*4*F
 show(g.roots())
 \end{python}
 Veiem que les arrels són de la forma
 \[
 \alpha \pm \sqrt{(\alpha-e_1)(\alpha-e_2)} \pm \sqrt{2\alpha^2-e_1\alpha-e_2\alpha - 2\alpha\sqrt{(\alpha-e_1)(\alpha-e_2)}}.
 \]
 
 \begin{remark}
  També podem resoldre l'equació $g(x)=0$ a mà: escrivim
  \[
  g(x) = (x^2+Ax+B)^2 - (Cx)^2,
  \]
  amb $A,B,C$ a determinar. Igualant coeficients veiem que una solució és
  \[
  A = -2\alpha,\quad B = e_1e_2,\quad
  C =  2\sqrt{(\alpha-e_1)(\alpha-e_2)}.
\]
Per tant,
\[
g(x) = (x^2 + (A+C)x + B)(x^2+(A-C)x + B),
\]
i fent servir la fórmula quadràtica arribem a les solucions desitjades.
 \end{remark}
 Veurem ara que es té $L_P\subseteq L_\alpha = \Q(\sqrt{\alpha-e_1},\sqrt{\alpha-e_2})$. Només ens cal veure que
 \[
 2\alpha^2-e_1\alpha-e_2\alpha-2\alpha\sqrt{(\alpha-e_1)(\alpha-e_2)} \in (L_\alpha^\times)^2
 \]
 Aquesta expressió la podem reescriure com
 \[
 2\alpha^2-e_1\alpha-e_2\alpha-2\alpha\sqrt{(\alpha-e_1)(\alpha-e_2)}=\left(\sqrt{\alpha(\alpha-e_1)} - \sqrt{\alpha(\alpha-e_2)}\right)^2,
 \]
 i per tant només ens cal veure que $\sqrt{\alpha}\in L_\alpha$. Fent servir l'equació d'$E$, tenim
 \[
 \sqrt{\alpha(\alpha-e_1)(\alpha -e_2)}=\sqrt{\alpha}\sqrt{\alpha-e_1}\sqrt{\alpha-e_2}=\pm\beta\in\Q,
 \]
 i per tant $\sqrt{\alpha}$ pertany a $L_\alpha$.

Per acabar, només hem de veure que el compost de tots els $L_\alpha$ és una extensió finita.

\begin{lemma}
 Si $E\colon y^2=x^3+ax^2+bx$ amb $a,b\in\Z$, aleshores les coordenades-$x$ dels punts d'$E(\Q)$ només prenen un nombre finit de valors, mòdul quadrats.
\end{lemma}
\begin{proof}
 Primer, deixem com a exercici veure que si $(x,y)\in E(\Q)$, aleshores $x=m/e^2$ i $y=n/e^3$ amb $m,n,e\in \Z$ i $\gcd(e,m)=\gcd(e,n)=1$. Per fer-ho, s'escriu $x=m/M$ i $y=n/N$, i de l'equació d'$E$ es dedueix que $N^2=M^3$ (veient per separat les dues divisibilitats).
 
 Sabem doncs que $(x,y)=(m/e^2,n/e^2)$ amb $\gcd(m,e)=\gcd(n,e)=1$. Volem estudiar la part lliure de quadrats de l'enter $m$. Substituint-ho a l'equació d'$E$ i netejant denominadors obtenim
 \[
 n^2=m(m^2+ame^2+be^4).
 \]
 Per tant, el producte de la dreta és un quadrat, i si escrivim $g=\gcd(m,m^2+ame^2+be^4)$, aleshores
 \[
 n^2 = g^2 m_1 m_2,\text{ amb } \gcd(m_1,m_2)=1,
 \]
 d'on en deduïm que $m_1$ i $m_2$ són quadrats. Per tant, $m=gr^2$ i per tant l'enter $g$ és un múltiple  de la part lliure de quadrats d'$m$.
 
 Com que $g\mid m$, aleshores $g\mid be^4$. Com que $\gcd(g,e)=1$, obtenim $g\mid b$. Per tant, els possibles $g$ són divisors de $b$, i d'aquests n'hi ha un nombre finit.
\end{proof}

El lema anterior ens dona una quantitat finita d'extensions $\Q(\sqrt{\alpha})$, però també hem de tractar amb $\Q(\sqrt{\alpha-e_1})$. Considerem la corba el·líptica
\[
E'\colon y^2=x(x+e_1)(x+e_1-e_2).
\]
Si $(\alpha,\beta)\in E(\Q)$, aleshores $(\alpha -e_1,\beta)\in E'(\Q)$. Per tant, aplicant el lema a $E'$ obtenim també un nombre finit de possibilitats per $\Q(\sqrt{\alpha-e_1})$ i per tant també per les possibilitats d'$L_P$. Així, el compost de tots els $L_P$ és una extensió finita.

 \subsection{Corbes sobre cossos finits}
 
 En aquesta secció tractarem amb corbes el·líptiques $E$ definides sobre un cos finit $\F_q$ de $q=p^r$ elements, per cert primer $p$ i $r\geq 1$.

Fixem-nos que òbviament $E(\F_q)$ és finit. De fet, com a molt es tenen $2q+1$ punts: el punt de l'infinit, i per cada tria d'$x$ obtenim un polinomi en $y$ de grau $2$, que com a molt té dues arrels. Podem afinar l'anàlisi una mica més: per cada valor d'$x$, el polinomi quadràtic té o bé zero o dues solucions, i si cadascun dels casos es dona amb la mateixa freqüència obtindríem uns $q+1$ punts.

\begin{example}
Considerem la corba el·líptica
\[
E\colon y^2=x^3-x+1.
\]
Com que $\Delta_E = - 2^4\cdot 23$, podem considerar la corba mòdul diferents primers, excepte $2$ i $23$. Si escrivim $a_p(E)=p+1-\#E(\F_p)$, obtenim la taula:
\begin{table}[ht]
\centering
    \begin{tabular}{lllllllllllll}
\toprule
      $p$&3&5&7&11&13&17&19&29&31&37  \\
\midrule
      $\#E(\F_p)$&7&8&12&10&19&14&22&37&35&36\\
    $a_p(E)$&-3&-2&-4&2&-5&4&-2&-7&-3&2\\
    \bottomrule
    \end{tabular}
\caption{Nombre de punts d'$E(\F_p)$ al variar $p$.}
    \end{table}
\begin{figure}[ht!]
\centering
\includegraphics[height=.3\textheight]{pointcounts.pdf}
\caption{Il·lustració del Teorema de Hasse per la corba $E\colon y^2=x^3-x+1$}
\end{figure}
\end{example}

\begin{theorem}[Teorema de Hasse]
 Si $E$ és una corba el·líptica definida sobre $\F_q$, aleshores
 \[
 |\# E(\F_q) - (q+1)|\leq 2\sqrt{q}.
 \]
\end{theorem}

En la demostració del teorema anterior, és crucial estudiar la isogènia següent (les aplicacions entre corbes el·líptiques que són algebraiques i que a més preserven l'estructura de grup s'anomenen \emph{isogènies}):

\begin{definition}
Sigui $E/\F_q$ una corba el·líptica. L'\emph{endomorfisme de Frobenius} és la isogènia
\[
\phi_E\colon E\to E,\quad (x,y)\mapsto(x^q,y^q).
\]
\end{definition}

\begin{remark}
Observem que si $(x,y)\in E(\bar\F_q)$ satisfà l'equació de la corba, posem
\[
y^2=x^3+ax+b,
\]
aleshores
\[
y^2q = (x^3+ax+b)^q = (x^q)^3 + a^q x^q + b^q = (x^q)^3 + ax^q + b,
\]
on hem fet servir que $q$ és una potència de $p$ (i $p$ és la característica del cos), el teorema del ``binomi del Batxillerat'' i el fet que $a$ i $b$ són de $\F_q$.
\end{remark}

\begin{proof}[Idea de la demostració del Teorema de Hasse]
Es basa en tres fets fonamentals, la demostració dels quals ometrem.
\begin{enumerate}
    \item A cada isogènia $\varphi\in \End(E)$ se li pot assignar un grau $\deg(\varphi)$.
    \item $\deg(\phi_E)=q$ i $\deg([m])=m^2$ per a tot $m\in\Z$,
    \item La isogènia $\phi_E-1$ té nucli de tamany $\deg(\phi_E-1)$, i
    \item $\deg\colon\End(E)\to\Z$ és una forma quadràtica.
\end{enumerate}
La desigualtat de Cauchy--Schwartz diu aleshores que donades isogènies $\varphi_1$ i $\varphi_2$ es té
\[
|\deg(\varphi_1-\varphi_2)-\deg(\varphi_1)-\deg(\varphi_2)|\leq 2\sqrt{\deg(\varphi_1)\deg(\varphi_2)}.
\]
Aplicant aquesta desigualtat a $\varphi_1=\phi_E$ i $\varphi_2=[1]$ obtenim el resultat, ja que $\#E(\F_q)=\#\ker(\phi_E-1)=\deg(\phi_E-1)$.
\end{proof}
\begin{proposition}
 Sigui $E/\F_q$ una corba el·líptica, i escrivim $a= q+1 - \#E(\F_q)$. Aleshores $\phi_E$ satisfà
\[
\phi_E^2 - a\phi_E + q =0.
\]
\end{proposition}

\begin{remark}
La proposició diu que per a tot punt $P=(x,y) \in E(\bar\F_q)$, es té
\[
(x^{q^2},y^{q^2}) - a\cdot (x^q,y^q) + q\cdot(x,y) = \calO.
\]
Aquí, recordem que les operacions $-$ i $+$ i $\cdot$ es corresponen a la llei de grup.
\end{remark}

El següent teorema ens dona una manera fàcil de calcular $\#E(\F_{q^n})$ si la corba $E$ està definida sobre $\F_q$ i sabem calcular $\#E(\F_q)$. Considerem el polinomi $X^2-aX + q$, on $a=q+1-\# E(\F_q)$, que té discriminant $a^2-4q \leq 0$ pel Teorema de Hasse. Per tant, les seves arrels $\alpha,\beta\in\C$ són complexes conjugats, i el seu producte és $q$, per tant $|\alpha|=|\beta|=\sqrt{q}$.
\begin{theorem}
 Sigui $E$ una corba el·líptica definida sobre $\F_q$. Aleshores,
 \[
 \# E(\F_{q^n}) = q^n + 1 - \alpha^n - \beta^n,\quad \forall n\geq 1.
 \]
\end{theorem}
 
% També ens podem preguntar per l'estructura de grup d'$E(\F_q)$.
 
% \begin{theorem}
%  El grup $E(\F_q)$ és el producte de dos grups cíclics. Per tant, si escrivim $N=\#E(\F_q)$, tenim
%  \[
%  E(\F_q) \cong \prod_{p\mid N} \Z/p^\alpha_p\Z \times \Z/p^\beta_p\Z,
%  \]
%  on $\alpha_p\geq 1$ i $\beta_p\geq 0$ per a tot $p\mid N$.
% \end{theorem}
 
 \subsection{Criptografia amb corbes el·líptiques}
 
 \subsubsection{Diffie--Hellman amb corbes el·líptiques}
 Recordem que el protocol de Diffie--Hellman fa servir l'operació de grup a $\F_p^\times$, que és un grup cíclic, per establir una clau comuna entre Alice i Bob. Podem canviar el grup $\F_p^\times$ pel grup generat per un punt $P\in E(\F_q)$. Denotem per $N$ l'ordre del punt $P$ (fixem-nos que $N\simeq q$, pel teorema de Hasse). Això resulta en el següent protocol (compareu-lo amb la \S\ref{sec:diffie-hellman}).
 
 \begin{enumerate}
    \item L'Alice escull un enter a l'atzar $1<a<N$, i envia el punt $Q_A=aP\in E(\F_q)$ a en Bob.
    \item En Bob, per la seva banda, escull un enter a l'atzar $1<b<N$, i envia el punt $Q_B=bP\in E(\F_q)$ a l'Alice.
    \item L'Alice i en Bob calculen respectivament $aQ_B$ i $bQ_A$. Observem que els dos punts calculats són iguals a $abP$, que serà el secret compartit.
\end{enumerate}

En aquest cas, també es creu que \emph{problema de Diffie--Hellman per corbes el·líptiques (ECDHP)} i el \emph{problema del logaritme discret per corbes el·líptiques (ECDLP)} són equivalents. Òbviament, la seguretat del sistema depèn de l'ordre $N$ del punt $P$ escollit, i per tant ens interessarà trobar corbes el·líptiques $E/\F_q$ tals que $\#E(\F_q)$ sigui divisible per un primer gran.

Per altra banda, l'algoritme més potent per resoldre el logaritme discret a $\F_q^\times$, que s'anomena ``Index Calculus'', no té anàleg a $E(\F_q)$. Això fa que per solucionar el logaritme discret a $E(\F_q)$ només es tinguin disponibles els algoritmes que funcionen per grups cyclic genèrics. Conseqüentment, un sistema criptogràfic basat en l'ECDLP pugui assolir la mateixa seguretat que un sistema basat en el DLP treballant amb un cos finit de cardinal molt menor.

La companyia Certicom\footnote{\url{https://www.certicom.com/content/certicom/en/the-certicom-ecc-challenge.html}} té diferents reptes de resoldre el logaritme discret en corbes el·líptiques, i ofereix 20.000\$ a qui trobi el logaritme discret d'un punt concret d'una corba $E$ definida sobre $\F_p$, on $p=1550031797834347859248576414813139942411$ (131 bits). En canvi, des del 2005 es pot (amb tècniques molt avançades i amb molt d'esforç computacional) resoldre el logaritme discret per primers d'aquest tamany. De fet, es pot fer per primers de fins a 180 bits. Es considera que la seguretat en corbes el·líptiques obtinguda amb primers d'uns 160 bits és comprable a l'obtinguda a $\F_p^\times$ amb primers de 1024 bits, mentre que amb només 256 bits s'obté la seguretat corresponent a 4096 bits de $\F_p^\times$.

 \subsubsection{ElGamal amb corbes el·líptiques}
 Una variant del protocol de Diffie--Hellman ens permet establir un sistema de xifrat de clau pública basat en el logaritme discret. El descriurem de manera uniforme per  un grup $G=\F_q^\times$ o $G=E(\F_q)$.
 
 \begin{description}
 \item[Preparació: ] Cada usuari (posem Alice) tria un element $g\in G$ d'ordre $N$ suficientment gran. Seguidament, tria un enter $2< a < N$ i calcula $A=g^a$. La clau pública de l'Alice serà la tupla $(G,g,A)$, i la clau secreta serà $a$.
 \item[Xifrat: ] Suposem que en Bob vol enviar un missatge $m\in G$ a l'Alice. En Bob tria un enter a l'atzar, $2< y < N$, i calcula $Y=g^y\in G$ i també $Z=mA^y$. Aleshores envia a Alice la tupla $(Y,Z)$.
 \item[Desxifrat: ] Per recuperar el missatge, Alice calcula $Y^{-a} Z$. Observem que
 \[
 Y^{-a}Z = g^{-ay}mg^{ay} = m.
 \]
 \end{description}
 Fixem-nos que la part de preparació s'assembla molt al que fa l'Alice amb el protocol Diffie--Hellman, mentre que la part de xifrat s'assembla al que faria en Bob, amb la diferència que la part ``secreta`` $y$ va canviant a cada missatge. Aleshores la part ``pública'' $Y$ permet acordar un secret comú (que seria $Y^a=g^{ay}=A^y$), i que és justament el secret que s'ha fet servir per emmascarar el missatge $m$.
 
 Si un possible atacant que tingui accés a la comunicació vol recuperar el missatge $m$ a partir de $(Y,Z)$, haurà de trobar el secret a partir de $Y=g^y$ i de $A=g^a$, i això és precisament el problema de Diffie--Hellman, que estem assumint igual de difícil que el problema del logaritme discret.
 
 \subsection{Comptatge de punts}
 En aquest apartat volem estudiar el problema de determinar, donada una corba $E/\F_p$, el nombre de punts $\# E(\F_p)$. Ja sabem que, pel Teorema de Hasse,
 \[
 \# E(\F_p) = p + 1 - t,\quad |t|\leq 2\sqrt{p}.
 \]
 Suposem també que $p>3$ (en cas contrari, és molt fàcil determinar $E(\F_p)$), i escrivim $E$ en la forma
 \[
 E\colon y^2=x^3+Ax+B, \quad A,B\in\F_p.
 \]
 Per cada $a\in \F_p$, definim
 \[
 \chi(a)=\begin{cases}
 0&\text{si } a=0,\\
 +1&\text{si } a\in(\F_p^\times)^2,\\
 -1&\text{si } a\in \F_p^\times\smallsetminus (\F_p^\times)^2.
 \end{cases}
 \]
 Aleshores, observem que
 \[
 \# E(\F_p) = 1+ \sum_{x\in\F_p} (1+\chi(x^3+Ax+B))= 1+p+\sum_{x\in\F_p} \chi(x^3+Ax+B),
 \]
 i per tant tenim una formula tancada per $t$:
 \[
 t = \sum_{x\in\F_p}\chi(x^3+Ax+B).
 \]
 A la secció següent veurem una manera eficient de calcular $\chi(x)$ per qualsevol $x\in\F_p$. Tot i així, si $p$ és molt gran (de manera que ens sigui útil en criptografia) no podrem recórrer\footnote{En l'actualitat es fan servir primeres d'entre $50$ i $80$ xifres decimals, i cal tenir en compte que un ordinador actual trigaria l'edat de l'univers a recórrer els enters entre $1$ i $10^{27}$.} tots els elements de $\F_p$.
 
 \subsubsection{L'algoritme d'Schoof}
 El 1985, R.~Schoof va donar el primer algoritme que calculava $\#E(\F_p)$ amb un nombre d'operacions polinomial en $\log(p)$, fet que va permetre d'utilitzar les corbes el·líptiques en la criptografia de manera pràctica. Seguidament veurem les idees principals de l'algoritme d'Schoof.
 
 Recordem que l'endomorfisme de Frobenius
 \[
 \phi\colon E\to E,\quad (x,y)\mapsto (x^p,y^p)
 \]
 satisfà l'equació quadràtica
 \[
 \phi^2-t\phi+q = 0.
 \]
 Sigui $P=(x,y)\in E(K)$, on $K/\F_p$ és una extensió qualsevol. Aleshores
 \begin{align}
 \label{eq:frobenius-schoof}
 (x^{p^2},y^{p^2}) + [p] (x,y) = [t] (x^p,y^p).
 \end{align}
 La quantitat de l'esquerra es pot calcular de manera eficient, fent servir exponenciació modular pel primer terme, i l'anàleg de l'exponenciació modular per corbes el·líptiques pel segon.
 
 \begin{remark}
 Fixem-nos que l'enter $t$ no es pot extreure directament de $[t]$, ja que si $(x,y)$ té ordre $N$, aleshores $(x^p,y^p)$ també (per què?), i per tant $[t+kN](x^p,y^p)=[t](x^p,y^p)$ per a tot $k$. Així, només podem determinar $t$ mòdul $N$. 
 \end{remark}
 
 La idea de Schoof consisteix en determinar $t\pmod \ell$ per suficients primers $\ell$ petits, i després reconstruir $t$ fent servir el teorema xinès dels residus. Per exemple, per determinar $\#E(\F_p)$ amb $p\simeq 10^{71}$ n'hi ha prou amb considerar $2<\ell<100$. Afegint-hi els 5 primers que hi ha fins a $\ell < 115$ ja podem determinar $\#E(\F_p)$ amb $p\simeq 10^{91}$, i amb dos primers més ($127$, $131$) ja podem arribar a $p\simeq 10^{100}$.
 
 Fem primer el cas $\ell=2$.
 \begin{lemma}
  \[
  t\bmod 2=\begin{cases}
  1 & \text{si } x^3+Ax+B\text{ és irreductible a } \F_p,\\
  0 & \text{altrament.}
  \end{cases}
  \]
 \end{lemma}
\begin{proof}
 Recordem que $x^3+Ax+B$ factoritza a $\F_p$ si i només si $E(\F_p)$ té un element d'ordre $2$ (que és $(\alpha,0)$ on $\alpha$ és una arrel de $x^3+Ax+B$). Ara bé, com que $p$ és senar tenim
 \[
 \# E(\F_p) = p+1-t\equiv t\pmod 2,
 \]
 i $E(\F_p)$ té un element d'ordre $2$ si i només si $\#E(\F_p)$ és parell.
 \end{proof}
 
 Així, considerem ara un primer $\ell$ senar, i ens cal trobar un punt d'ordre $\ell$. No podem esperar que aquest punt estigui definit a $\F_p$, i per tant en general haurem de considerar extensions $K/\F_p$. 
 
 \begin{theorem}
  Considerem els polinomis $\psi_m\in\F_p[x,y]$,
  \begin{align*}
  \psi_1&=1,\quad \psi_2=2y,\\
  \psi_3 &= 3x^4+6Ax^2+12Bx-A^2,\\
  \psi_4&=4y(x^6+5Ax^4+20Bx^3-5A^2x^2-4ABx-8B^2-A^3),\\
  \psi_{2m+1}&=\psi_{m+2}\psi_{m}^3 - \psi_{m-1}\psi_{m+1}^3,& (m\geq 2),\\
  \psi_{2m}&=\frac{\psi_m}{2y}(\psi_{m+2}\psi_{m-1}^2-\psi_{m-2}\psi_{m+1}^2),& (m\geq 3).
  \end{align*}
  Aleshores per a tot primer senar $\ell<p$, $\psi_\ell\in \F_p[x,y^2]$ i, si substituim $y^2=x^3+Ax+B$ obtenim un polinomi en $x$ de grau $\frac{\ell^2-1}{2}$. A més,
  \[
  P\in E(\bar\F_p)[\ell]\smallsetminus\{\calO\}\iff \psi_\ell(x(P))=0. 
  \]
 \end{theorem}
 \begin{corollary}
 Per tot primer $\ell$, es té
  \[
  E[\ell]\cong\Z/\ell\Z\oplus\Z/\ell\Z.
  \]
 \end{corollary}
 \begin{proof}
  Els punts d'$E[\ell]=E(\bar\F_p)[\ell]$ són de la forma $(\alpha, \beta)$ on $\alpha$ és una arrel de $\psi_\ell$. Per tant, hi ha $1+2\deg(\psi_\ell)=\ell^2$ punts a $E[\ell]$. Com que tot $P\in E[\ell]$ satisfà $\ell P=\calO$, necessàriament $E[\ell]=\Z/\ell\Z\oplus\Z/\ell\Z$.
 \end{proof}
 Si prenem $K/\F_p$ un cos on $\psi_\ell$ tingui alguna arrel $\alpha$, aleshores podem considerar el punt de $\ell$-torsió $P=(\alpha,\sqrt{D})\in E(K(\sqrt{D}))$, on $D=\alpha^3+A\alpha+B$.
 
 La següent millora ens permet treballar al cos $K$, sense afegir una arrel de $D$. Considerem la corba
 \[
 E^D \colon y^2 = x^3 + AD^2x + BD^3.
 \]
 Aleshores l'isomorfisme
 \[
 \tau\colon E\to E^D,\quad (x,y\delta)\mapsto (Dx,D^2y), \quad \delta=\sqrt{D}
 \]
 ens permet realitzar totes les operacions a $E^D(K)$. Observem que
\begin{align*}
    \tau((\alpha,\delta)) &= (D\alpha, D^2),\\
    \tau((\alpha^p,\delta^p)) &=(D\alpha^p,D^{\frac{p+3}{2}}),\\
    \tau((\alpha^{p^2},\delta^{p^2})) &=(D\alpha^{p^2},D^{\frac{p^2+3}{2}}).
\end{align*}
Per tant, l'equació~\eqref{eq:frobenius-schoof} és equivalent a la següent equació a $E^D$:
\[
(D\alpha^{p^2},D^{\frac{p^2+3}{2}}) + [p] (D\alpha,D^2) = [t] (D\alpha^p,D^{\frac{p+3}{2}}).
\]

Vegem la complexitat d'aquest algoritme. Els polinomis $\psi_\ell$ tenen grau $O(\ell^2)=O(\log^2 p)$. Per tant, els elements de l'extensió $K$ tenen tamany $O(\ell^2\log q)=O(\log^3 q)$. Per calcular $\alpha^p$ i $\alpha^{p^2}$ calen $O(\log p)$ operacions a $K$, i per tant en total $O((\log p)(\log^3 p)^2)$, és a dir $O(\log^7 p)$. Com que això s'ha de fer per $O(\log p)$ primers (pel Teorema dels Nombres Primers), en total calen $O(\log^8 p)$ operacions de bit. Si es poden fer operacions a $K$ de manera més ràpida (per exemple fent servir transformades de Fourier) es pot reduir la complexitat a $O(\log^{5+\epsilon} p)$. Millores posteriors de Elkies i Atkin permeten calcular $\#E(\F_p)$ amb temps $O(\log^{4+\epsilon} p)$.

Acabem la secció amb una implementació en  \texttt{Sage} de l'algoritme d'Schoof.

\begin{algo}
  \caption{Donats enters $A$ i $B$ i un primer $p$, calcula $p+1-\#E(\F_p)$, on $E$ és la corba el·líptica
    $y^2=x^3+Ax+B$}
\begin{python}    
def t_mod(A, B, p, ell):
    pmod = p % ell
    if pmod > ell / 2: pmod -= ell
    R.<t> = PolynomialRing(GF(p)))
    if ell == 2: return 1 if (t^3+A*t+B).is_irreducible() else 0
    h = E.division_polynomial(ell,t,0).factor()[0][0]
    K.<a> = FiniteField(p^h.degree(), modulus = h)    # K = F[x]/(h(x))
    D = a^3 + A * a + B
    E = EllipticCurve([A*D^2, B*D^3])
    P = E([D*a,D^2])
    phi_P = E([D * a^p, D^((p+3)//2)])
    phi2_P = E([D * a^(p^2), D^((p^2+3)//2)])
    LHS = phi2_P + pmod * P; RHS = E(0)
    for t in xrange((ell+1)//2):
        if LHS ==  RHS: return t
        elif LHS == -RHS: return -t
        RHS += phi_P
\end{python}
\begin{python}
def Schoof(A, B, p): # y^2 = x^3 + Ax + B 
    M = 1; ell = 1; S = []; traces = []
    while M <= 4*RR(p).sqrt():
        ell = next_prime(ell); S.append(ell); M *= ell
        traces.append(t_mod(A, B, p, ell))      
    t = CRT(traces, S) # Fem servir el Teorema Xinès dels Residus
    return t if t < M / 2 else t-M
  \end{python}
\end{algo}
